<script>
  const map = L.map('map').setView([38.7169, -9.1399], 12);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
  }).addTo(map);

  const icons = {
    'Carta I - Milita': L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41],
    }),
    'Carta II - Nizette': L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41],
    }),
  };

  const lineColors = {
    'Carta I - Milita': 'blue',
    'Carta II - Nizette': 'violet',
  };

  const apiUrl = 'https://script.google.com/macros/s/AKfycbxBgPWvdXWv5oTYJj1IQumRgYtgG_eJpyxmWdfuJCI5hSanW7dtKjukNPGY_dkXfxL8/exec';
  const cacheKey = "geocodeCache";
  let geocodeCache = JSON.parse(localStorage.getItem(cacheKey) || '{}');

  async function geocodeAddress(address) {
    if (geocodeCache[address]) return geocodeCache[address];

    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
      const data = await res.json();
      if (data && data.length > 0) {
        const result = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
        geocodeCache[address] = result;
        localStorage.setItem(cacheKey, JSON.stringify(geocodeCache));
        return result;
      }
    } catch (e) {
      console.error("Erro na geocodificação:", address, e);
    }
    return null;
  }

  function addMarkerToMap(lat, lon, popupHtml, icon) {
    L.marker([lat, lon], { icon }).addTo(map).bindPopup(popupHtml);
  }

  function hideLoader() {
    document.getElementById('loader').style.display = 'none';
  }

  function showLoader() {
    document.getElementById('loader').style.display = 'flex';
  }

  function jsonpCallback(dados) {
    if (!dados || !dados.length) {
      alert("Nenhuma morada encontrada.");
      hideLoader();
      return;
    }

    const pathGroups = {
      'Carta I - Milita': [],
      'Carta II - Nizette': [],
    };

    (async () => {
      for (const item of dados) {
        const morada = item['morada']?.trim();
        if (!morada) continue;

        const coords = await geocodeAddress(morada);
        if (!coords) continue;

        const dataHora = item['carimbo de data/hora'] || 'Sem data';
        const nome = item['nome'] || 'Sem nome';

        const comentarioKey = Object.keys(item).find(key =>
          key.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').includes('coment')
        );
        const comentario = item[comentarioKey] || 'Sem comentário';

        const cartaKey = Object.keys(item).find(key =>
          key.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').includes('carta')
        );
        const carta = item[cartaKey]?.trim() || 'Carta I - Milita';

        const popupHtml = `
          <b>Data:</b> ${dataHora}<br/>
          <b>Nome:</b> ${nome}<br/>
          <b>Morada:</b> ${morada}<br/>
          <b>Comentário:</b> ${comentario}<br/>
          <b>Carta:</b> ${carta}
        `;

        const markerIcon = icons[carta] || icons['Carta I - Milita'];
        addMarkerToMap(coords.lat, coords.lon, popupHtml, markerIcon);

        if (!pathGroups[carta]) pathGroups[carta] = [];
        pathGroups[carta].push([coords.lat, coords.lon]);

        await new Promise(resolve => setTimeout(resolve, 100));
      }

      // Desenhar as linhas (polylines) por grupo
      for (const [carta, coordsArray] of Object.entries(pathGroups)) {
        if (coordsArray.length >= 2) {
          L.polyline(coordsArray, {
            color: lineColors[carta] || 'gray',
            weight: 3,
            opacity: 0.7,
            smoothFactor: 1
          }).addTo(map);
        }
      }

      hideLoader();
    })();
  }

  showLoader();

  const script = document.createElement('script');
  script.src = apiUrl + '?callback=jsonpCallback';
  document.body.appendChild(script);
</script>




