<script>
  const map = L.map('map').setView([38.7169, -9.1399], 12);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
  }).addTo(map);

  const icons = {
    'Carta I - Milita': L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25,41], iconAnchor: [12,41],
      popupAnchor:[1,-34], shadowSize:[41,41]
    }),
    'Carta II - Nizette': L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25,41], iconAnchor: [12,41],
      popupAnchor:[1,-34], shadowSize:[41,41]
    }),
  };

  const lineColors = {
    'Carta I - Milita': 'blue',
    'Carta II - Nizette': 'violet',
  };

  const apiUrl = 'https://script.google.com/macros/s/AKfycbxBgPWvdXWv5oTYJj1IQumRgYtgG_eJpyxmWdfuJCI5hSanW7dtKjukNPGY_dkXfxL8/exec';
  const cacheKey = "geocodeCache";
  let geocodeCache = JSON.parse(localStorage.getItem(cacheKey) || '{}');

  async function geocodeAddress(address) {
    if (geocodeCache[address]) return geocodeCache[address];
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
      const d = await res.json();
      if (d && d.length>0) {
        const r = {lat: parseFloat(d[0].lat), lon: parseFloat(d[0].lon)};
        geocodeCache[address] = r;
        localStorage.setItem(cacheKey, JSON.stringify(geocodeCache));
        return r;
      }
    } catch(e){ console.error("Erro geocode",address,e); }
    return null;
  }

  function addMarker(lat, lon, html, icon) {
    L.marker([lat,lon], {icon}).addTo(map).bindPopup(html);
  }

  function hideLoader(){ document.getElementById('loader').style.display = 'none'; }
  function showLoader(){ document.getElementById('loader').style.display = 'flex'; }

  function jsonpCallback(dados) {
    if (!dados || !dados.length) {
      alert("Nenhuma morada encontrada.");
      hideLoader();
      return;
    }

    const pathGroups = {};

    (async () => {
      for (const item of dados) {
        const morada = item['morada']?.trim();
        if (!morada) continue;

        const coords = await geocodeAddress(morada);
        if (!coords) continue;

        const dataHora = new Date(item['carimbo de data/hora'] || Date.now());
        const nome = item['nome'] || 'Sem nome';

        const comentarioKey = Object.keys(item).find(key =>
          key.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').includes('coment')
        );
        const comentario = item[comentarioKey] || 'Sem comentário';

        const cartaKey = Object.keys(item).find(key =>
          key.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').includes('carta')
        );
        const carta = item[cartaKey]?.trim() || 'Carta I - Milita';

        const popupHtml = `
          <b>Data:</b> ${dataHora.toLocaleString()}<br/>
          <b>Nome:</b> ${nome}<br/>
          <b>Morada:</b> ${morada}<br/>
          <b>Comentário:</b> ${comentario}<br/>
          <b>Carta:</b> ${carta}
        `;

        addMarker(coords.lat, coords.lon, popupHtml, icons[carta] || icons['Carta I - Milita']);

        if (!pathGroups[carta]) pathGroups[carta] = [];
        pathGroups[carta].push({lat: coords.lat, lon: coords.lon, date: dataHora});

        await new Promise(r=>setTimeout(r,100));
      }

      // Agora desenharemos as linhas
      Object.entries(pathGroups).forEach(([carta, pts]) => {
        if (pts.length < 2) return;
        pts.sort((a,b) => a.date - b.date);
        const coordsArr = pts.map(p => [p.lat, p.lon]);
        const poly = L.polyline(coordsArr, {
          color: lineColors[carta] || 'gray',
          weight: 3, opacity:0.7, smoothFactor:1
        }).addTo(map);

        poly.bindTooltip(`Ligação: ${carta}`, {
          permanent: false, direction: 'center', className: 'carta-tooltip'
        });

        poly.on('mouseover', function(){ this.setStyle({weight:6,opacity:1}); });
        poly.on('mouseout',  function(){ this.setStyle({weight:3,opacity:0.7}); });
        poly.on('click', function(){ map.fitBounds(this.getBounds()); });
      });

      hideLoader();
    })();
  }

  showLoader();
  const script = document.createElement('script');
  script.src = apiUrl + '?callback=jsonpCallback';
  document.body.appendChild(script);
</script>
